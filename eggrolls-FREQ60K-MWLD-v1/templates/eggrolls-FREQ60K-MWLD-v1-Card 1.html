<article class="card">
  <!-- Card Header: Word Display -->
  <header class="card-header">
    <h1 class="word">{{Word}}</h1>
    <span class="pos-badge {{^PoS}}is-empty{{/PoS}}">
      {{#PoS}}{{PoS}}{{/PoS}}
      {{^PoS}}&nbsp;{{/PoS}}
    </span>
    <a href="https://www.merriam-webster.com/dictionary/{{Word}}" class="search-button" title="Search in Merriam-Webster" target="_blank">
      <img src="_logo-light.svg" alt="Merriam-Webster" class="logo-light">
      <img src="_logo-dark.svg" alt="Merriam-Webster" class="logo-dark">
    </a>
  </header>

  <!-- Pronunciation and Audio -->
  <section class="pronunciation-audio">
    <span class="pronunciation">/{{IPA}}/</span>
    {{#Audio}}
    <span class="audio-button" onclick="new Audio('{{Audio}}').play();">
      <svg width="100%" height="100%" viewBox="0 0 24 24">
        <path d="M5.25 9v6h4l5 5V4L9.25 9H5.25z M18.75 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
      </svg>
    </span>
    {{/Audio}}
  </section>

  <hr class="divider">

  <!-- Example Sentences Section -->
  <section class="examples-section">
    <h2 class="section-title">Examples</h2>
    <ul class="examples-list">
      {{#Example1}}<li class="example-item">{{Example1}}</li>{{/Example1}}
      {{#Example2}}<li class="example-item">{{Example2}}</li>{{/Example2}}
      {{#Example3}}<li class="example-item">{{Example3}}</li>{{/Example3}}
    </ul>
  </section>

  <!-- Immediate script to process example sentence formatting -->
  <script>
    (function() {
      function cleanExampleSentenceForCoca(sentenceHTML) {
        if (typeof sentenceHTML !== 'string' || !sentenceHTML) return "";
        
        let cleaned = sentenceHTML;
        cleaned = cleaned.replace(/\[.*?\]/g, '');

        const equalsIndex = cleaned.indexOf('=');
        if (equalsIndex !== -1) {
          cleaned = cleaned.substring(0, equalsIndex);
        }
        
        cleaned = cleaned.replace(/\s+/g, ' ');
        return cleaned.trim();
      }

      const exampleItems = document.querySelectorAll('article.card .examples-section .example-item');
      exampleItems.forEach(item => {
        if (item.innerHTML) {
          const originalHTML = item.innerHTML;
          const cleanedHTML = cleanExampleSentenceForCoca(originalHTML);
          if (originalHTML !== cleanedHTML) {
            item.innerHTML = cleanedHTML;
          }
        }
        
        const html = item.innerHTML;
        const updatedHTML = html.replace(/(\([^)]*\)|\[[^\]]*\])/g, (match) => {
          return match.replace(/<(i|b)(\s[^>]*)?>([^<]*)<\/(i|b)>/g, (tagMatch, tag1, attrs, content, tag2) => {
            const hasClass = attrs && attrs.includes('class=');
            if (hasClass) {
              return tagMatch.replace(/class="([^"]*)"/, 'class="$1 in-brackets"');
            } else {
              const attributePart = attrs || '';
              return `<${tag1}${attributePart} class="in-brackets">${content}</${tag2}>`;
            }
          });
        });
        if (html !== updatedHTML) {
          item.innerHTML = updatedHTML;
        }
        item.classList.add('processed');
      });
    })();
  </script>

<script>
  function cleanExampleSentenceForCoca(sentenceHTML) {
    if (typeof sentenceHTML !== 'string' || !sentenceHTML) return "";
    
    let cleaned = sentenceHTML;
    cleaned = cleaned.replace(/\[.*?\]/g, '');

    const equalsIndex = cleaned.indexOf('=');
    if (equalsIndex !== -1) {
      cleaned = cleaned.substring(0, equalsIndex);
    }
    
    cleaned = cleaned.replace(/\s+/g, ' ');
    return cleaned.trim();
  }

  function markTagsInBrackets() {
    const exampleItems = document.querySelectorAll('article.card .examples-section .example-item');
    exampleItems.forEach(item => {
      const html = item.innerHTML;
      
      const updatedHTML = html.replace(/(\([^)]*\)|\[[^\]]*\])/g, (match) => {
        return match.replace(/<(i|b)(\s[^>]*)?>([^<]*)<\/(i|b)>/g, (tagMatch, tag1, attrs, content, tag2) => {
          const hasClass = attrs && attrs.includes('class=');
          if (hasClass) {
            return tagMatch.replace(/class="([^"]*)"/, 'class="$1 in-brackets"');
          } else {
            const attributePart = attrs || '';
            return `<${tag1}${attributePart} class="in-brackets">${content}</${tag2}>`;
          }
        });
      });
      
      if (html !== updatedHTML) {
        item.innerHTML = updatedHTML;
      }
      
      item.classList.add('processed');
    });
  }

  function applyCocaExampleCleaning() {
    const alreadyProcessed = document.querySelector('.example-item.processed');
    if (alreadyProcessed) {
      return;
    }
    
    const exampleItems = document.querySelectorAll('article.card .examples-section .example-item');
    exampleItems.forEach(item => {
      if (item.innerHTML) {
        const originalHTML = item.innerHTML;
        const cleanedHTML = cleanExampleSentenceForCoca(originalHTML);
        if (originalHTML !== cleanedHTML) {
          item.innerHTML = cleanedHTML;
        }
      }
    });
    
    markTagsInBrackets();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyCocaExampleCleaning);
  } else {
    applyCocaExampleCleaning();
  }
</script>

</article>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dictionary Card</title>
</head>
<body>

<article class="card">
  <!-- Card Header: Word + Part of Speech -->
  <header class="card-header">
    <h1 class="word">{{Word}}</h1>
    <span class="pos-badge {{^PoS}}is-empty{{/PoS}}">
      {{#PoS}}{{PoS}}{{/PoS}}
      {{^PoS}}&nbsp;{{/PoS}}
    </span>
    <a href="https://www.merriam-webster.com/dictionary/{{Word}}" class="search-button" title="Search in Merriam-Webster" target="_blank">
      <img src="_logo-light.svg" alt="Merriam-Webster" class="logo-light">
      <img src="_logo-dark.svg" alt="Merriam-Webster" class="logo-dark">
    </a>
  </header>

  <!-- Pronunciation and Audio -->
  <section class="pronunciation-audio">
    <span class="pronunciation">/{{IPA}}/</span>
    {{#Audio}}
    <span class="audio-button" onclick="new Audio('{{Audio}}').play();">
      <svg width="100%" height="100%" viewBox="0 0 24 24">
        <path d="M5.25 9v6h4l5 5V4L9.25 9H5.25z M18.75 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
      </svg>
    </span>
    {{/Audio}}


    <button id="translateBtn" class="translate-button" title="Click to translate">
      <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12.913 17H20.087M12.913 17L11 21M12.913 17L15.7783 11.009C16.0092 10.5263 16.1246 10.2849 16.2826 10.2086C16.4199 10.1423 16.5801 10.1423 16.7174 10.2086C16.8754 10.2849 16.9908 10.5263 17.2217 11.009L20.087 17M20.087 17L22 21M2 5H8M8 5H11.5M8 5V3M11.5 5H14M11.5 5C11.0039 7.95729 9.85259 10.6362 8.16555 12.8844M10 14C9.38747 13.7248 8.76265 13.3421 8.16555 12.8844M8.16555 12.8844C6.81302 11.8478 5.60276 10.4266 5 9M8.16555 12.8844C6.56086 15.0229 4.47143 16.7718 2 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </section>

  <!-- Grammar Information -->
  {{#Label}}
  <div class="grammar">{{Label}}</div>
  {{/Label}}

  <hr class="divider">

  <!-- Definition Section -->
  <section class="definition-section">
    <h2 class="section-title">Definition</h2>
    <div class="definition-content" data-translation="{{DefinitionTR}}">{{Definition}}</div>
  </section>

  <hr class="divider">

  <!-- Example Sentences Section -->
  <section class="examples-section">
    <h2 class="section-title">Examples</h2>
    <ul class="examples-list">
      {{#Example1}}
      <li class="example-sentence" data-translation="{{ExampleTR1}}">
        <span class="example-item">{{Example1}}</span>
        <div class="example-audio">
          <a class="tts-button audio-button soundLink">
            <svg width="100%" height="100%" viewBox="0 0 24 24">
              <path d="M5.25 9v6h4l5 5V4L9.25 9H5.25z M18.75 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
          </a>
        </div>
      </li>
      {{/Example1}}

      {{#Example2}}
      <li class="example-sentence" data-translation="{{ExampleTR2}}">
        <span class="example-item">{{Example2}}</span>
        <div class="example-audio">
          <a class="tts-button audio-button soundLink">
            <svg width="100%" height="100%" viewBox="0 0 24 24">
              <path d="M5.25 9v6h4l5 5V4L9.25 9H5.25z M18.75 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
          </a>
        </div>
      </li>
      {{/Example2}}

      {{#Example3}}
      <li class="example-sentence" data-translation="{{ExampleTR3}}">
        <span class="example-item">{{Example3}}</span>
        <div class="example-audio">
          <a class="tts-button audio-button soundLink">
            <svg width="100%" height="100%" viewBox="0 0 24 24">
              <path d="M5.25 9v6h4l5 5V4L9.25 9H5.25z M18.75 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
          </a>
        </div>
      </li>
      {{/Example3}}
    </ul>
  </section>
</article>

  <!-- Script to process tag formatting in example sentences -->
  <script>
    (function() {
      const exampleItems = document.querySelectorAll('article.card .examples-section .example-item');
      exampleItems.forEach(item => {
        const html = item.innerHTML;
        const updatedHTML = html.replace(/(\([^)]*\)|\[[^\]]*\])/g, (match) => {
          return match.replace(/<(i|b)(\s[^>]*)?>([^<]*)<\/(i|b)>/g, (tagMatch, tag1, attrs, content, tag2) => {
            const hasClass = attrs && attrs.includes('class=');
            if (hasClass) {
              return tagMatch.replace(/class="([^"]*)"/, 'class="$1 in-brackets"');
            } else {
              const attributePart = attrs || '';
              return `<${tag1}${attributePart} class="in-brackets">${content}</${tag2}>`;
            }
          });
        });
        if (html !== updatedHTML) {
          item.innerHTML = updatedHTML;
        }
        item.classList.add('processed');
      });
    })();
  </script>

<script>
  // Example TTS functionality
  function setExampleTTS() {
    const ttsConfig = {
      domain: [
        'https://anki-eng.0w0.live/',
        'https://ms-ra-forwarder-for-ifreetime-pbbu.vercel.app/',
      ],
      params: { speed: -4 }
    };

    const getVoice = () => {
      const voices = [
        'en-US-AriaNeural','en-US-EmmaNeural','en-US-JennyNeural',
        'en-US-ChristopherNeural','en-US-EricNeural','en-US-GuyNeural',
        'en-US-MichelleNeural','en-US-SteffanNeural'
      ];
      return voices[Date.now() % voices.length];
    };

    const getExampleText = el => {
      if (!el) return '';
      let text = el.textContent || el.innerText || '';
      text = text.replace(/\[.*?\]/g, '');
      const idx = text.indexOf('=');
      if (idx !== -1) text = text.substring(0, idx);
      return text.replace(/\s+/g, ' ').trim();
    };

    document.querySelectorAll('.example-sentence').forEach(sentence => {
      const exampleItem = sentence.querySelector('.example-item');
      const audioContainer = sentence.querySelector('.example-audio');
      const ttsButton = audioContainer.querySelector('.tts-button');
      if (!exampleItem || !audioContainer || !ttsButton) return;
      if (audioContainer.querySelector('audio') || ttsButton.dataset.initialized) return;

      const text = getExampleText(exampleItem);
      if (!text) return;

      const qs = new URLSearchParams({
        ...ttsConfig.params,
        text, voiceName: getVoice()
      });

      const audio = document.createElement('audio');
      audio.preload = 'none';
      ttsConfig.domain.forEach(url => {
        const src = document.createElement('source');
        src.src = `${url}api/aiyue?${qs}`;
        src.type = 'audio/mpeg';
        audio.appendChild(src);
      });
      audioContainer.appendChild(audio);

      ttsButton.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('article.card audio').forEach(a => a !== audio && !a.paused && a.pause());
        audio.currentTime = 0;
        audio.play();
      });
      ttsButton.dataset.initialized = 'true';
    });
  }

  // Local translation functionality
  function translateContent() {
    const btn = document.getElementById('translateBtn');
    const defContent = document.querySelector('.definition-content');
    const exampleLis = document.querySelectorAll('.example-sentence');

    // Display definition translation
    const defCN = defContent.dataset.translation?.trim();
    if (defCN && !defContent.querySelector('.translation')) {
      defContent.insertAdjacentHTML(
        'beforeend',
        `<div class="translation translation-definition">${defCN}</div>`
      );
    }
    
    // Display example translations
    exampleLis.forEach(li => {
      const exCN = li.dataset.translation?.trim();
      if (exCN && !li.nextElementSibling?.classList.contains('translation')) {
        li.insertAdjacentHTML(
          'afterend',
          `<div class="translation translation-example">
             <span style="color: var(--example-highlight);">â†³</span>${exCN}
           </div>`
        );
      }
    });
    
    // Update button icon to checkmark
    btn.innerHTML =
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">' +
      '<path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" ' +
      'stroke-linecap="round" stroke-linejoin="round"/></svg>';
  }

  function markTagsInBrackets() {
    const exampleItems = document.querySelectorAll('article.card .examples-section .example-item');
    exampleItems.forEach(item => {
      const html = item.innerHTML;
      
      const updatedHTML = html.replace(/(\([^)]*\)|\[[^\]]*\])/g, (match) => {
        return match.replace(/<(i|b)(\s[^>]*)?>([^<]*)<\/(i|b)>/g, (tagMatch, tag1, attrs, content, tag2) => {
          const hasClass = attrs && attrs.includes('class=');
          if (hasClass) {
            return tagMatch.replace(/class="([^"]*)"/, 'class="$1 in-brackets"');
          } else {
            const attributePart = attrs || '';
            return `<${tag1}${attributePart} class="in-brackets">${content}</${tag2}>`;
          }
        });
      });
      
      if (html !== updatedHTML) {
        item.innerHTML = updatedHTML;
      }
      
      item.classList.add('processed');
    });
  }

  function initializePage() {
    setExampleTTS();
    markTagsInBrackets();
    const btn = document.getElementById('translateBtn');
    if (btn) {
      btn.removeEventListener('click', translateContent);
      btn.addEventListener('click', translateContent);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePage);
  } else { 
    initializePage();
  }

  window.addEventListener('load', initializePage);

  setInterval(() => {
    const btn = document.getElementById('translateBtn');
    if (btn && !btn.dataset.initialized && !btn.onclick) {
      btn.dataset.initialized = 'true';
      initializePage();
    }
  }, 500);

  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(muts => {
      let need = false;
      muts.forEach(m => {
        if (m.type === 'childList' && m.addedNodes.length) {
          for (const n of m.addedNodes) {
            if (n.nodeType === 1 && (n.matches('.card') || n.querySelector?.('.card'))) {
              need = true; 
              break;
            }
          }
        }
      });
      if (need) setTimeout(initializePage, 100);
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>

</body>
</html>
